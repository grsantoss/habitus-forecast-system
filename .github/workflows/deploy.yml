name: Deploy to Production

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build e push das imagens Docker
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}-backend
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm install -g pnpm@10.4.1
          pnpm install --frozen-lockfile
          pnpm run build
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: builder
          push: false
          tags: ${{ steps.meta.outputs.tags }}-frontend
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy (escolha uma op√ß√£o abaixo)
  
  # Op√ß√£o 1: Deploy via SSH (VPS)
  deploy-ssh:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            echo "üöÄ Iniciando deploy..."
            
            # Vari√°veis (ajustar conforme necess√°rio)
            APP_DIR="${SERVER_APP_DIR:-/var/www/habitus-forecast-system}"
            COMPOSE_FILES="docker-compose.yml docker-compose.prod.yml"
            
            # Navegar para diret√≥rio da aplica√ß√£o
            cd "$APP_DIR" || { echo "‚ùå Diret√≥rio n√£o encontrado: $APP_DIR"; exit 1; }
            
            # Backup do banco antes de atualizar (opcional)
            echo "üì¶ Fazendo backup do banco de dados..."
            docker-compose -f $COMPOSE_FILES exec -T db pg_dump -U ${POSTGRES_USER:-habitus} ${POSTGRES_DB:-habitus_forecast} > backup_$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || echo "‚ö†Ô∏è Backup n√£o dispon√≠vel (banco pode n√£o estar rodando)"
            
            # Atualizar c√≥digo
            echo "üì• Atualizando c√≥digo..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # Pull de imagens Docker (se usando registry)
            echo "üê≥ Atualizando imagens Docker..."
            docker-compose -f $COMPOSE_FILES pull || echo "‚ö†Ô∏è Pull de imagens falhou (continuando com build local)"
            
            # Build e restart dos containers
            echo "üî® Construindo e iniciando containers..."
            docker-compose -f $COMPOSE_FILES up -d --build
            
            # Aguardar backend estar pronto
            echo "‚è≥ Aguardando backend estar pronto..."
            sleep 10
            
            # Executar migra√ß√µes do banco
            echo "üóÑÔ∏è Executando migra√ß√µes do banco de dados..."
            docker-compose -f $COMPOSE_FILES exec -T backend alembic upgrade head || echo "‚ö†Ô∏è Migra√ß√µes falharam (verificar logs)"
            
            # Verificar sa√∫de da aplica√ß√£o
            echo "üè• Verificando sa√∫de da aplica√ß√£o..."
            sleep 5
            HEALTH_CHECK=$(docker-compose -f $COMPOSE_FILES exec -T backend curl -f http://localhost:5000/api/health 2>/dev/null || echo "FAIL")
            if [[ "$HEALTH_CHECK" == *"ok"* ]]; then
              echo "‚úÖ Deploy conclu√≠do com sucesso!"
            else
              echo "‚ö†Ô∏è Health check falhou, mas containers est√£o rodando"
            fi
            
            # Limpar imagens antigas (opcional)
            echo "üßπ Limpando imagens antigas..."
            docker image prune -f || true
            
            echo "‚ú® Deploy finalizado!"

  # Op√ß√£o 2: Deploy para Railway (desabilitado por padr√£o)
  # Descomente e configure secrets se quiser usar Railway
  # deploy-railway:
  #   name: Deploy to Railway
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     
  #     - name: Deploy to Railway
  #       uses: bervProject/railway-deploy@v1.0.0
  #       with:
  #         railway_token: ${{ secrets.RAILWAY_TOKEN }}
  #         service: habitus-forecast

  # Op√ß√£o 3: Deploy para Render (desabilitado por padr√£o)
  # Descomente e configure secrets se quiser usar Render
  # deploy-render:
  #   name: Deploy to Render
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  #   
  #   steps:
  #     - name: Trigger Render Deploy
  #       run: |
  #         curl -X POST "https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}?key=${{ secrets.RENDER_API_KEY }}"

  # Notifica√ß√£o de deploy
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "‚úÖ Build completed successfully"
          else
            echo "‚ùå Build failed"
          fi

