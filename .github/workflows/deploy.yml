name: Deploy to Production

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build e push das imagens Docker
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # Verificar estrutura do projeto
      - name: Verify project structure
        run: |
          echo "üìÅ Verificando estrutura do projeto..."
          ls -la
          echo "üìÅ Backend:"
          ls -la backend/ || echo "‚ùå Pasta backend n√£o encontrada"
          echo "üìÅ Frontend:"
          ls -la frontend/ || echo "‚ùå Pasta frontend n√£o encontrada"
          echo "üìÑ Dockerfiles:"
          test -f backend/Dockerfile && echo "‚úÖ backend/Dockerfile existe" || echo "‚ùå backend/Dockerfile n√£o encontrado"
          test -f frontend/Dockerfile && echo "‚úÖ frontend/Dockerfile existe" || echo "‚ùå frontend/Dockerfile n√£o encontrado"
      
      # Metadata para backend
      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      
      # Debug: Mostrar tags do backend
      - name: Debug backend tags
        run: |
          echo "üè∑Ô∏è Tags do backend:"
          echo "${{ steps.meta-backend.outputs.tags }}"
          echo "üè∑Ô∏è Labels do backend:"
          echo "${{ steps.meta-backend.outputs.labels }}"
      
      # Metadata para frontend
      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      
      # Debug: Mostrar tags do frontend
      - name: Debug frontend tags
        run: |
          echo "üè∑Ô∏è Tags do frontend:"
          echo "${{ steps.meta-frontend.outputs.tags }}"
          echo "üè∑Ô∏è Labels do frontend:"
          echo "${{ steps.meta-frontend.outputs.labels }}"
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: builder
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # Deploy (escolha uma op√ß√£o abaixo)
  
  # Op√ß√£o 1: Deploy via SSH (VPS)
  deploy-ssh:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H -p ${{ secrets.SSH_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -euxo pipefail
            echo "üöÄ Iniciando deploy..."
            echo "üìã Informa√ß√µes do ambiente:"
            echo "  - Host: ${{ secrets.SERVER_HOST }}"
            echo "  - Usu√°rio: ${{ secrets.SERVER_USER }}"
            echo "  - Branch: ${{ github.ref }}"
            echo "  - Commit: ${{ github.sha }}"
            
            # Vari√°veis (ajustar conforme necess√°rio)
            APP_DIR="${SERVER_APP_DIR:-/var/www/habitus-forecast-system}"
            COMPOSE_FLAGS="-f docker-compose.yml -f docker-compose.prod.yml"
            
            # Verificar se diret√≥rio existe
            echo "üìÅ Verificando diret√≥rio da aplica√ß√£o: $APP_DIR"
            if [ ! -d "$APP_DIR" ]; then
              echo "‚ùå ERRO: Diret√≥rio n√£o encontrado: $APP_DIR"
              echo "üí° Criando diret√≥rio..."
              sudo mkdir -p "$APP_DIR" || exit 1
              sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} "$APP_DIR" || exit 1
            fi
            
            # Navegar para diret√≥rio da aplica√ß√£o
            cd "$APP_DIR" || { echo "‚ùå Erro ao acessar diret√≥rio: $APP_DIR"; exit 1; }
            echo "‚úÖ Diret√≥rio atual: $(pwd)"
            
            # Verificar se √© reposit√≥rio git
            if [ ! -d ".git" ]; then
              echo "‚ö†Ô∏è Diret√≥rio n√£o √© um reposit√≥rio git. Inicializando..."
              git init || exit 1
              git remote add origin https://github.com/${{ github.repository }}.git || true
            fi
            
            # Backup do banco antes de atualizar (opcional)
            echo "üì¶ Fazendo backup do banco de dados..."
            docker compose $COMPOSE_FLAGS exec -T db pg_dump -U ${POSTGRES_USER:-habitus} ${POSTGRES_DB:-habitus_forecast} > backup_$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || echo "‚ö†Ô∏è Backup n√£o dispon√≠vel (banco pode n√£o estar rodando)"
            
            # Atualizar c√≥digo
            echo "üì• Atualizando c√≥digo..."
            git fetch origin || { echo "‚ùå Erro ao fazer fetch"; exit 1; }
            git reset --hard origin/main 2>/dev/null || git reset --hard origin/master || { echo "‚ùå Erro ao fazer reset"; exit 1; }
            echo "‚úÖ C√≥digo atualizado. √öltimo commit: $(git log -1 --oneline)"
            
            # Verificar docker-compose files
            echo "üìÑ Verificando arquivos docker-compose..."
            test -f docker-compose.yml && echo "‚úÖ docker-compose.yml encontrado" || { echo "‚ùå docker-compose.yml n√£o encontrado"; exit 1; }
            test -f docker-compose.prod.yml && echo "‚úÖ docker-compose.prod.yml encontrado" || echo "‚ö†Ô∏è docker-compose.prod.yml n√£o encontrado (continuando...)"
            
            # Pull de imagens Docker (se usando registry)
            echo "üê≥ Atualizando imagens Docker..."
            docker compose $COMPOSE_FLAGS pull || echo "‚ö†Ô∏è Pull de imagens falhou (continuando com build local)"
            
            # Build e restart dos containers
            echo "üî® Construindo e iniciando containers..."
            docker compose $COMPOSE_FLAGS up -d --build || { 
              echo "‚ùå Erro ao construir/iniciar containers. Logs:"
              docker compose $COMPOSE_FLAGS logs --tail=100
              exit 1
            }
            
            # Aguardar backend estar pronto
            echo "‚è≥ Aguardando backend estar pronto..."
            sleep 10
            
            # Verificar se containers est√£o rodando
            echo "üîç Verificando status dos containers..."
            docker compose $COMPOSE_FLAGS ps
            
            # Executar migra√ß√µes do banco
            echo "üóÑÔ∏è Executando migra√ß√µes do banco de dados..."
            docker compose $COMPOSE_FLAGS exec -T backend alembic upgrade head || { 
              echo "‚ö†Ô∏è Migra√ß√µes falharam (verificar logs)"
              docker compose $COMPOSE_FLAGS logs --tail=50 backend
            }
            
            # Verificar sa√∫de da aplica√ß√£o
            echo "üè• Verificando sa√∫de da aplica√ß√£o..."
            sleep 5
            HEALTH_CHECK=$(docker compose $COMPOSE_FLAGS exec -T backend curl -fsS http://localhost:5000/api/health 2>/dev/null || echo "FAIL")
            if [[ "$HEALTH_CHECK" == *"ok"* ]] || [[ "$HEALTH_CHECK" == *"healthy"* ]]; then
              echo "‚úÖ Health check passou!"
              echo "‚úÖ Deploy conclu√≠do com sucesso!"
            else
              echo "‚ùå Health check falhou. Resposta: $HEALTH_CHECK"
              echo "üìã Mostrando logs do backend:"
              docker compose $COMPOSE_FLAGS logs --tail=200 backend || true
              echo "‚ö†Ô∏è Health check falhou, mas containers est√£o rodando"
              # N√£o falhar o deploy se health check falhar (pode ser tempor√°rio)
            fi
            
            # Limpar imagens antigas (opcional)
            echo "üßπ Limpando imagens antigas..."
            docker image prune -f || true
            
            echo "‚ú® Deploy finalizado!"

  # Op√ß√£o 2: Deploy para Railway (desabilitado por padr√£o)
  # Descomente e configure secrets se quiser usar Railway
  # deploy-railway:
  #   name: Deploy to Railway
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     
  #     - name: Deploy to Railway
  #       uses: bervProject/railway-deploy@v1.0.0
  #       with:
  #         railway_token: ${{ secrets.RAILWAY_TOKEN }}
  #         service: habitus-forecast

  # Op√ß√£o 3: Deploy para Render (desabilitado por padr√£o)
  # Descomente e configure secrets se quiser usar Render
  # deploy-render:
  #   name: Deploy to Render
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  #   
  #   steps:
  #     - name: Trigger Render Deploy
  #       run: |
  #         curl -X POST "https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}?key=${{ secrets.RENDER_API_KEY }}"

  # Notifica√ß√£o de deploy
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "‚úÖ Build completed successfully"
          else
            echo "‚ùå Build failed"
          fi

