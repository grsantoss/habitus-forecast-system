version: '3.8'

# Override para produ√ß√£o
# Use: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  backend:
    # Em produ√ß√£o, n√£o montar volumes de c√≥digo
    volumes:
      - ./backend/uploads:/app/uploads
      - backend_logs:/app/logs
    environment:
      FLASK_ENV: production
      FLASK_DEBUG: "False"
      WORKERS: ${WORKERS:-4}
    # N√£o usar hot reload em produ√ß√£o
    command: >
      sh -c "
        echo 'üîÑ Executando migra√ß√µes do banco de dados...' &&
        if bash scripts/run_migrations.sh; then
          echo 'üöÄ Iniciando servidor Gunicorn...' &&
          gunicorn --config gunicorn_config.py wsgi:application
        else
          echo '‚ùå ERRO: Falha ao executar migra√ß√µes!' >&2 &&
          echo '   Verifique os logs acima para mais detalhes.' >&2 &&
          echo '   A aplica√ß√£o n√£o ser√° iniciada at√© que as migra√ß√µes sejam corrigidas.' >&2 &&
          exit 1
        fi
      "
    restart: always

  # Frontend n√£o √© necess√°rio em produ√ß√£o (build est√°tico servido pelo backend)
  frontend:
    profiles:
      - never

